<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hilltops Daily Staff Diary</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background:#f6f7fb; }
    header { background:#1f3b2c; color:#fff; padding:16px 18px; }
    header h1 { margin:0; font-size:18px; }
    .wrap { max-width: 980px; margin: 18px auto; padding: 0 14px; }
    .card { background:#fff; border-radius: 14px; box-shadow: 0 2px 10px rgba(0,0,0,.06); padding: 16px; margin-bottom: 14px; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; }
    .field { flex: 1 1 220px; display:flex; flex-direction:column; gap:6px; margin-bottom: 10px; }
    label { font-weight: 700; font-size: 13px; color:#222; }
    input, select, textarea { padding: 10px; border:1px solid #d7dbe7; border-radius: 10px; font-size: 14px; }
    textarea { min-height: 90px; resize: vertical; }
    .pill { display:inline-block; padding:6px 10px; border-radius: 999px; background:#eef3ff; font-size: 12px; color:#203a8a; }
    .section-title { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .section-title h2 { margin:0; font-size: 16px; }
    .hidden { display:none; }
    .btn { background:#1f3b2c; color:#fff; border:0; border-radius: 12px; padding: 12px 14px; font-weight: 700; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn2 { background:#e7ebf7; color:#1a1a1a; }
    .status { margin-top: 10px; font-weight:700; }
    .calc { background:#f2f7f2; border:1px dashed #a8c1aa; padding: 10px; border-radius: 12px; }
    canvas { width: 100%; max-width: 560px; height: 180px; border:1px solid #d7dbe7; border-radius: 12px; background:#fff; touch-action: none; }
    small { color:#666; }
  </style>
</head>
<body>
  <header>
    <h1>Hilltops Free Range — Daily Staff Diary</h1>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="section-title">
        <h2>Daily Info</h2>
        <span class="pill" id="todayPill"></span>
      </div>

      <div class="row">
        <div class="field">
          <label>Date</label>
          <input type="date" id="date" />
        </div>
        <div class="field">
          <label>Work Type</label>
          <select id="workType">
            <option value="Egg Collection">Egg Collection</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Washing">Washing</option>
            <option value="Packing">Packing</option>
          </select>
        </div>
        <div class="field">
          <label>Submitted By</label>
          <input type="text" id="submittedBy" placeholder="Name" />
        </div>
      </div>
    </div>

    <!-- Common staff fields -->
    <div class="card">
      <h2>Staff & Hours</h2>

      <div class="row">
        <div class="field">
          <label>Number of Workers</label>
          <input type="number" id="numWorkers" min="0" step="1" />
        </div>

        <div class="field">
          <label>Worker Names</label>
          <input type="text" id="workerNames" placeholder="e.g., A, B, C" />
          <small>Comma separated is fine.</small>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Start Time</label>
          <input type="time" id="startTime" />
        </div>

        <div class="field">
          <label>End Time</label>
          <input type="time" id="endTime" />
        </div>

        <div class="field">
          <label>Break (minutes)</label>
          <input type="number" id="breakMins" min="0" step="5" value="0" />
        </div>

        <div class="field" id="travelWrap">
          <label>Travel Time (hours)</label>
          <input type="number" id="travelHours" step="0.25" value="2" />
          <small>Editable for egg collection only.</small>
        </div>

        <div class="field">
          <label>Work Time (hours)</label>
          <input type="number" id="workHours" step="0.25" readonly />
          <small>Auto-calculated from start/end minus break & travel.</small>
        </div>

        <div class="field">
          <label>Labour Hours (person-hours)</label>
          <input type="number" id="labourHours" step="0.25" readonly />
          <small>Paid person-hours = (Shift - Break) × Workers</small>
        </div>
      </div>

      <div class="calc" id="totalHoursBox">
        <strong>Total Hours:</strong> <span id="totalHoursOut">—</span>
      </div>
    </div>

    <!-- Egg Collection -->
    <div class="card" id="secEgg">
      <div class="section-title">
        <h2>Egg Collection</h2>
        <span class="pill">Travel counted separately</span>
      </div>

      <div class="row">
        <div class="field">
          <label>Eggs Collected (Total)</label>
          <input type="number" id="eggsCollected" min="0" step="1" />
        </div>
      </div>

      <div class="calc">
        <div><strong>Avg Eggs / Collection Hour:</strong> <span id="avgEggsHourOut">—</span></div>
        <div><strong>Avg Eggs / Person:</strong> <span id="avgEggsPersonOut">—</span></div>
        <small>Avg/hour uses Work Time (productive) only.</small>
      </div>
    </div>

    <!-- Maintenance -->
    <div class="card hidden" id="secMaint">
      <h2>Maintenance</h2>
      <div class="row">
        <div class="field">
          <label>Maintenance Type</label>
          <select id="maintenanceType">
            <option value="">Select…</option>
            <option value="Per-Flock">Per-Flock</option>
            <option value="General Farm">General Farm</option>
            <option value="Vehicle">Vehicle</option>
            <option value="Emergency">Emergency</option>
            <option value="Other">Other</option>
          </select>
        </div>
      </div>
      <div class="field">
        <label>What they did</label>
        <textarea id="maintenanceDetails" placeholder="Write details (what, where, outcome, pending items)"></textarea>
      </div>
    </div>

    <!-- Washing -->
    <div class="card hidden" id="secWash">
      <h2>Washing</h2>
      <div class="row">
        <div class="field">
          <label>Dirty Eggs</label>
          <input type="number" id="dirtyEggs" min="0" step="1" />
        </div>
        <div class="field">
          <label>Washed Eggs</label>
          <input type="number" id="washedEggs" min="0" step="1" />
        </div>
      </div>

      <div class="calc">
        <div><strong>Broken Eggs (Dirty - Washed):</strong> <span id="brokenEggsOut">—</span></div>
        <div><strong>Eggs Washed / Hour:</strong> <span id="washRateOut">—</span></div>
      </div>
    </div>

    <!-- Packing -->
    <div class="card hidden" id="secPack">
      <h2>Packing</h2>
      <div class="row">
        <div class="field">
          <label>Eggs to be packed</label>
          <input type="number" id="eggsToPack" min="0" step="1" />
        </div>
        <div class="field">
          <label>Packed Eggs</label>
          <input type="number" id="eggsPacked" min="0" step="1" />
        </div>
        <div class="field">
          <label>Broken eggs during packing</label>
          <input type="number" id="brokenPacked" min="0" step="1" />
        </div>
      </div>

      <div class="calc">
        <div><strong>Packing rate / hour:</strong> <span id="packRateOut">—</span></div>
      </div>
    </div>

    <!-- Remarks + Signature -->
    <div class="card">
      <h2>Remarks</h2>
      <div class="field">
        <label>Remarks / Notes</label>
        <textarea id="remarks" placeholder="Any delays, issues, reasons, extra notes…"></textarea>
      </div>

      <h2>Signature (optional)</h2>
      <small>Sign to confirm the diary entry is correct.</small>
      <div style="margin-top:10px;">
        <canvas id="sigCanvas" width="900" height="280"></canvas>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="btn btn2" id="clearSig" type="button">Clear Signature</button>
      </div>

      <div class="row" style="margin-top:14px;">
        <button class="btn" id="submitBtn" type="button">Submit Diary Entry</button>
      </div>

      <div class="status" id="status"></div>
    </div>
  </div>

  <script>
  // ---------------- CONFIG ----------------
  const WEB_APP_URL =
    "https://script.google.com/macros/s/AKfycbzx9EKoA0QnIy9F8vHaV3xRqI71bcUf8zTiQ5fXYM2Y8SHFhOdsVADQJOIRfkKFuQID/exec";

  const $ = (id) => document.getElementById(id);

  // ---------- Helpers ----------
  function todayISO() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function fmt(n) {
    if (n === "" || n === null || n === undefined) return "—";
    const x = Number(n);
    if (!Number.isFinite(x)) return "—";
    return x.toLocaleString(undefined, { maximumFractionDigits: 2 });
  }

  function nval(id) {
    const el = $(id);
    if (!el) return "";
    const v = el.value;
    if (v === "") return "";
    const n = Number(v);
    return Number.isFinite(n) ? n : "";
  }

  function sval(id) {
    const el = $(id);
    return el ? String(el.value || "").trim() : "";
  }

  function hide(el) { if (el) el.classList.add("hidden"); }
  function show(el) { if (el) el.classList.remove("hidden"); }

  function parseTimeToMinutes(t) {
    if (!t || !t.includes(":")) return null;
    const [hh, mm] = t.split(":").map(Number);
    if (!Number.isFinite(hh) || !Number.isFinite(mm)) return null;
    return hh * 60 + mm;
  }

  // Paid shift per person = (End - Start - Break)
  function calcPaidShiftHoursPerPerson() {
    const start = parseTimeToMinutes(sval("startTime"));
    const end = parseTimeToMinutes(sval("endTime"));
    const breakMins = Number(nval("breakMins") || 0);
    if (start === null || end === null) return "";

    let totalMins = end - start;
    if (totalMins < 0) totalMins += 24 * 60;

    let paidMins = totalMins - breakMins;
    if (paidMins < 0) paidMins = 0;

    return paidMins / 60;
  }

  // Productive work per person = (Shift - Break - Travel for egg collection)
  function calcWorkHoursPerPerson() {
    const type = sval("workType");
    const start = parseTimeToMinutes(sval("startTime"));
    const end = parseTimeToMinutes(sval("endTime"));
    const breakMins = Number(nval("breakMins") || 0);
    if (start === null || end === null) return "";

    let totalMins = end - start;
    if (totalMins < 0) totalMins += 24 * 60;

    const travelHours = type === "Egg Collection" ? Number(nval("travelHours") || 0) : 0;
    const travelMins = travelHours * 60;

    let workMins = totalMins - breakMins - travelMins;
    if (workMins < 0) workMins = 0;

    return workMins / 60;
  }

  // ---------- UI Sections ----------
  function showSection(type) {
    const egg = $("secEgg");
    const maint = $("secMaint");
    const wash = $("secWash");
    const pack = $("secPack");

    hide(egg); hide(maint); hide(wash); hide(pack);

    if (type === "Egg Collection") show(egg);
    if (type === "Maintenance") show(maint);
    if (type === "Washing") show(wash);
    if (type === "Packing") show(pack);

    const travelWrap = $("travelWrap");
    if (type === "Egg Collection") {
      show(travelWrap);
      const th = $("travelHours");
      if (th && (th.value === "" || Number(th.value) === 0)) th.value = "2";
    } else {
      hide(travelWrap);
    }

    recalc();
  }

  function recalc() {
    const type = sval("workType");
    const workers = Number(nval("numWorkers") || 0);

    const paidShiftPerPerson = calcPaidShiftHoursPerPerson();
    const workPerPerson = calcWorkHoursPerPerson();

    if ($("workHours")) {
      $("workHours").value =
        workPerPerson === "" ? "" : Number(workPerPerson).toFixed(2);
    }

    const labourHours =
      Number.isFinite(paidShiftPerPerson) && workers > 0
        ? paidShiftPerPerson * workers
        : "";

    if ($("labourHours")) {
      $("labourHours").value = labourHours === "" ? "" : labourHours.toFixed(2);
    }

    if ($("totalHoursOut")) $("totalHoursOut").textContent = fmt(labourHours);

    if (type === "Egg Collection") {
      const eggs = Number(nval("eggsCollected") || 0);
      const w = Number.isFinite(workPerPerson) ? workPerPerson : 0;
      const avgHr = w > 0 ? eggs / w : "";
      const avgPerson = workers > 0 ? eggs / workers : "";
      if ($("avgEggsHourOut")) $("avgEggsHourOut").textContent = fmt(avgHr);
      if ($("avgEggsPersonOut")) $("avgEggsPersonOut").textContent = fmt(avgPerson);
    }

    if (type === "Washing") {
      const dirty = nval("dirtyEggs");
      const washed = nval("washedEggs");
      const w = Number.isFinite(workPerPerson) ? workPerPerson : 0;
      const broken =
        Number.isFinite(dirty) && Number.isFinite(washed) ? Math.max(0, dirty - washed) : "";
      const rate =
        Number.isFinite(washed) && w > 0 ? washed / w : "";
      if ($("brokenEggsOut")) $("brokenEggsOut").textContent = fmt(broken);
      if ($("washRateOut")) $("washRateOut").textContent = fmt(rate);
    }

    if (type === "Packing") {
      const packed = nval("eggsPacked");
      const w = Number.isFinite(workPerPerson) ? workPerPerson : 0;
      const rate = Number.isFinite(packed) && w > 0 ? packed / w : "";
      if ($("packRateOut")) $("packRateOut").textContent = fmt(rate);
    }
  }

  // ---------- Signature Pad (iPhone-safe) ----------
  let canvas, ctx;
  let drawing = false;
  let last = null;

  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches && e.touches[0];
    const clientX = touch ? touch.clientX : e.clientX;
    const clientY = touch ? touch.clientY : e.clientY;
    return {
      x: (clientX - rect.left) * (canvas.width / rect.width),
      y: (clientY - rect.top) * (canvas.height / rect.height),
    };
  }

  function startDraw(e) {
    drawing = true;
    last = getPos(e);
    e.preventDefault();
  }

  function moveDraw(e) {
    if (!drawing) return;
    const p = getPos(e);
    ctx.lineWidth = 4;
    ctx.lineCap = "round";
    ctx.beginPath();
    ctx.moveTo(last.x, last.y);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    last = p;
    e.preventDefault();
  }

  function endDraw(e) {
    drawing = false;
    last = null;
    e.preventDefault();
  }

  function clearSignature() {
    if (!ctx || !canvas) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  function resetFormKeepDateAndSubmitter() {
    if ($("numWorkers")) $("numWorkers").value = "";
    if ($("workerNames")) $("workerNames").value = "";
    if ($("startTime")) $("startTime").value = "";
    if ($("endTime")) $("endTime").value = "";
    if ($("breakMins")) $("breakMins").value = "0";
    if ($("workHours")) $("workHours").value = "";
    if ($("labourHours")) $("labourHours").value = "";

    if (sval("workType") === "Egg Collection") {
      if ($("travelHours")) $("travelHours").value = $("travelHours").value || "2";
    }

    ["eggsCollected","maintenanceType","maintenanceDetails","dirtyEggs","washedEggs","eggsToPack","eggsPacked","brokenPacked","remarks"]
      .forEach(id => { if ($(id)) $(id).value = ""; });

    clearSignature();
    recalc();
  }

  async function submitDiary() {
    const status = $("status");
    const btn = $("submitBtn");
    if (status) status.textContent = "";

    const date = sval("date");
    const workType = sval("workType");
    const submittedBy = sval("submittedBy");

    if (!date) { if (status) status.textContent = "❌ Please select a date."; return; }
    if (!submittedBy) { if (status) status.textContent = "❌ Please fill 'Submitted By'."; return; }

    recalc();

    const workers = Number(nval("numWorkers") || 0);
    const travelFinal = workType === "Egg Collection" ? Number(nval("travelHours") || 0) : 0;

    const paidShiftPerPerson = calcPaidShiftHoursPerPerson();
    const workPerPerson = calcWorkHoursPerPerson();

    const labourHours =
      Number.isFinite(paidShiftPerPerson) && workers > 0 ? paidShiftPerPerson * workers : "";

    const payload = {
      date,
      workType,
      numWorkers: workers,
      workerNames: sval("workerNames"),

      startTime: sval("startTime"),
      endTime: sval("endTime"),
      breakMins: nval("breakMins"),

      travelHours: travelFinal,
      workHours: Number.isFinite(workPerPerson) ? Number(workPerPerson) : 0,
      labourHours: labourHours,

      eggsCollected: nval("eggsCollected"),

      maintenanceType: sval("maintenanceType"),
      maintenanceDetails: sval("maintenanceDetails"),

      dirtyEggs: nval("dirtyEggs"),
      washedEggs: nval("washedEggs"),

      eggsToPack: nval("eggsToPack"),
      eggsPacked: nval("eggsPacked"),
      brokenPacked: nval("brokenPacked"),

      remarks: sval("remarks"),
      submittedBy,

      signatureDataURL: canvas ? canvas.toDataURL("image/png") : "",
    };

    if (btn) btn.disabled = true;
    if (status) status.textContent = "Submitting…";

    try {
      const body = new URLSearchParams();
      body.append("data", JSON.stringify(payload));

      await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body });

      if (status) status.textContent = "✅ Submitted! (Saved to sheet)";
      resetFormKeepDateAndSubmitter();
    } catch (e) {
      if (status) status.textContent = "❌ Network error: " + String(e);
    } finally {
      if (btn) btn.disabled = false;
    }
  }

  // ---------- Init ----------
  window.addEventListener("load", () => {
    const t = todayISO();
    if ($("date")) $("date").value = t;
    if ($("todayPill")) $("todayPill").textContent = `Today: ${t}`;

    canvas = $("sigCanvas");
    if (canvas) {
      ctx = canvas.getContext("2d");
      canvas.addEventListener("mousedown", startDraw);
      canvas.addEventListener("mousemove", moveDraw);
      canvas.addEventListener("mouseup", endDraw);
      canvas.addEventListener("mouseleave", endDraw);

      canvas.addEventListener("touchstart", startDraw, { passive: false });
      canvas.addEventListener("touchmove", moveDraw, { passive: false });
      canvas.addEventListener("touchend", endDraw, { passive: false });
      canvas.addEventListener("touchcancel", endDraw, { passive: false });
    }

    if ($("clearSig")) $("clearSig").addEventListener("click", clearSignature);
    if ($("submitBtn")) $("submitBtn").addEventListener("click", submitDiary);

    if ($("workType")) {
      showSection($("workType").value);
      $("workType").addEventListener("change", (e) => showSection(e.target.value));
    }

    [
      "numWorkers","workerNames","startTime","endTime","breakMins","travelHours",
      "eggsCollected","dirtyEggs","washedEggs","eggsPacked"
    ].forEach((id) => {
      const el = $(id);
      if (el) {
        el.addEventListener("input", recalc);
        el.addEventListener("change", recalc);
      }
    });

    recalc();
  });
  </script>
</body>
</html>
